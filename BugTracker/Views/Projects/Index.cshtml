@model IEnumerable<BugTracker.Models.Project>
@using BugTracker.Models
@using BugTracker.HelperExtensions

<h2>Projects</h2>
@if (User.IsInRole("Administrator") || User.IsInRole("Project Manager"))
{
    @: <div id="projectsRender" class="col-md-9">
}
else
{
    @: <div id="projectsRender" class="col-md-12">
}
    @if (Model.Count() != 0)
    {
        foreach (var project in Model)
        {
            <div class="box-info shadow">
                <h2>@project.Name <small> Due: @project.Deadline.FormatDateTimeOffsetCondensed()</small>
                </h2>
                <div id="headerButtons">
                    <a role="button" data-toggle="collapse" data-parent="#projectsRender" data-target="#collapse-@project.Id" aria-expanded="false"><i class="btn btn-warning fa fa-eye"></i></a>
                    @if (User.IsInRole("Administrator") || User.IsInRole("Project Manager"))
                    {
                        <a href=@Url.Action("Create", "Tickets", new { id = project.Id }) class="btn btn-warning"><i class="fa fa-plus"></i> Ticket</a>
                            <button type="button" class="editProject btn btn-warning" data-id="@project.Id"><i class="fa fa-edit"></i></button>
                    }
                </div>
                  
                <div id="collapse-@project.Id" class="collapse" role="tabpanel">
                    <div class="row">
                        <div class="col-md-3">
                            <dl>
                                <dt>Project Manager</dt>
                                <dd>@project.ProjectManager.FullName</dd>
                                <dt>Version</dt>
                                @if (project.Version != null)
                                {
                                    <dd>@project.Version</dd> }
                                else {
                                    <dd><small>none given</small></dd> }
                            </dl>
                        </div>
                        <div class="col-md-3">
                            <dl>
                                <dt>Description</dt>
                                <dd>@project.Description</dd>
                            </dl>
                        </div>
                        <div class="col-md-3">
                            <dl>
                                <dt>Created</dt>
                                <dd>@project.Created.DateTime.ToShortDateString()</dd>
                                <dt>Last Modified</dt>
                                    <dd>@project.LastModified.FormatDateTimeOffsetCondensed()</dd> 
                            </dl>
                        </div>
                        <div class="col-md-3">
                            <dl>
                                <dt>Assigned Users</dt>
                                <dd>
                                    <ul class="list-unstyled">
                                        @if (project.Users != null)
                                        {
                                            foreach (var user in project.Users)
                                            {
                                                if (user.FullName != null)
                                                {
                                                    <li>@user.FullName</li>}
                                            }
                                        }
                                    </ul>
                                </dd>
                            </dl>
                        </div>
                    </div>
                    <div class="col-md-12">
                        <table>
                            <caption>Active Tickets</caption>
                            <thead>
                                <tr>
                                    <th>Ticket Name</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Assigned To</th>
                                    <th>Phase</th>
                                    <th>Action</th>
                                    <th>Submitted</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var ticket in project.Tickets)
                                {
                                    <tr>
                                        <td>@ticket.Name</td>

                                        @if (ticket.Priority != null)
                                        {
                                            <td>@ticket.Priority.Name</td> }
                                        else {
                                            <td><small>none given</small></td>}

                                        <td>@ticket.Status.Name</td>

                                        @if (ticket.AssignedToId != null)
                                        {
                                            <td>@ticket.AssignedTo.FullName</td> }
                                        else {
                                            <td><small>not assigned</small></td> }

                                        @if (ticket.Phase != null)
                                        {
                                            <td>@ticket.Phase.Name</td> }
                                        else {
                                            <td><small>none given</small></td> }

                                        @if (ticket.Action != null)
                                        {
                                            <td>@ticket.Action.Name</td> }
                                        else {
                                            <td><small>none given</small></td> }

                                        <td>@ticket.Submitted.DateTime.ToShortDateString()</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                    <div class="col-md-12">
                        <table>
                            <caption>Change Log</caption>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Modified Property</th>
                                    <th>New Value</th>
                                    <th>Old Value</th>
                                    <th>Modified By</th>
                                </tr>
                            </thead>
                            <tbody>
                                @if (project.Logs.Count() == 0)
                                {
                                    <tr><td>There have been no changes to this project.</td></tr>
                                }
                                else
                                {
                                    foreach (var log in project.Logs)
                                    {
                                        <tr>
                                            <td>@log.Modified.DateTime.ToShortDateString()</td>
                                            <td>@log.Property</td>
                                            <td>@log.NewValue</td>
                                            <td>@log.OldValue</td>
                                            <td>@log.ModifiedBy.FullName</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

        }
    }
    else
    {
        <div class="box-info shadow">
            <h2>Projects</h2>
            <p>There are no current projects.</p>
        </div>
    }
</div>
@if (User.IsInRole("Administrator") || User.IsInRole("Project Manager"))
{
    <div class="col-md-3">
        <div id="editView" class="box-info shadow">
@Html.Action("_Create")
        </div>
    </div>
}
